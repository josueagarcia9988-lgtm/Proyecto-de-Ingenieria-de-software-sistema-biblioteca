{% extends "base.html" %}

{% block title %}{{ 'Editar' if tipo else 'Nuevo' }} Tipo de Documento{% endblock %}

{% block content %}
<div class="form-wrapper">
    <div class="form-container">
        <div class="form-header">
            <a href="{{ url_for('tipos_documentos.listar') }}" class="back-link">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Volver
            </a>
            <h1>{{ 'Editar Tipo de Documento' if tipo else 'Nuevo Tipo de Documento' }}</h1>
            <p>{{ 'Actualiza la información del tipo' if tipo else 'Completa los datos del nuevo tipo' }}</p>
        </div>

        <form method="POST" id="tipoForm" class="form-content">
            <div class="form-grid">
                <!-- ID (solo al crear) -->
                {% if not tipo %}
                <div class="form-group full-width">
                    <label for="id_tipo_documento">ID <span class="required">*</span></label>
                    <input type="number" 
                           id="id_tipo_documento" 
                           name="id_tipo_documento" 
                           class="form-input"
                           required
                           min="1"
                           max="9999"
                           step="1"
                           placeholder="Ej: 1, 2, 3..."
                           autofocus>
                    <small class="form-hint">Número único entre 1 y 9999</small>
                </div>
                {% else %}
                <div class="info-box">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                    <div>
                        <strong>ID del Tipo: #{{ tipo.id_tipo_documento }}</strong>
                        <p>El ID no puede ser modificado después de creado</p>
                    </div>
                </div>
                {% endif %}

                <!-- Nombre -->
                <div class="form-group full-width">
                    <label for="nombre">Nombre <span class="required">*</span></label>
                    <input type="text" 
                           id="nombre" 
                           name="nombre" 
                           class="form-input"
                           value="{{ tipo.nombre if tipo else '' }}"
                           required
                           minlength="2"
                           maxlength="30"
                           placeholder="Ej: DNI, Pasaporte, Cédula..."
                           {{ 'autofocus' if tipo else '' }}>
                    <small class="form-hint" id="nombreHint">2-30 caracteres (letras, números, espacios, guiones y puntos)</small>
                </div>

                <!-- Descripción -->
                <div class="form-group full-width">
                    <label for="descripcion">Descripción</label>
                    <textarea id="descripcion" 
                              name="descripcion" 
                              class="form-input" 
                              rows="3"
                              maxlength="100"
                              placeholder="Descripción breve del tipo de documento (mínimo 5 caracteres, opcional)">{{ tipo.descripcion if tipo else '' }}</textarea>
                    <small class="form-hint" id="descripcionHint">Máximo 100 caracteres (mínimo 5 si se completa)</small>
                </div>

                <!-- Estado Activo -->
                <div class="form-group full-width">
                    <div class="toggle-container">
                        <label class="toggle-label">
                            <input type="checkbox" 
                                   id="activo" 
                                   name="activo"
                                   {{ 'checked' if not tipo or tipo.activo else '' }}>
                            <span class="toggle-switch"></span>
                        </label>
                        <div class="toggle-info">
                            <strong>Estado Activo</strong>
                            <p>Permite que este tipo de documento esté disponible para uso en el sistema</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botones -->
            <div class="form-actions">
                <a href="{{ url_for('tipos_documentos.listar') }}" class="btn btn-secondary">Cancelar</a>
                <button type="submit" class="btn btn-primary">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    {{ 'Actualizar' if tipo else 'Crear' }} Tipo
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.form-wrapper {
    max-width: 700px;
    margin: 2rem auto;
    padding: 0 1rem;
}

.form-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.form-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    text-align: center;
    position: relative;
}

.back-link {
    position: absolute;
    top: 1.5rem;
    left: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: white;
    text-decoration: none;
    font-weight: 500;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    transition: background 0.2s;
}

.back-link:hover {
    background: rgba(255, 255, 255, 0.2);
    color: white;
}

.form-header h1 {
    margin: 0 0 0.5rem 0;
    font-size: 1.75rem;
    font-weight: 700;
}

.form-header p {
    margin: 0;
    opacity: 0.9;
}

.form-content {
    padding: 2rem;
}

.form-grid {
    display: grid;
    gap: 1.5rem;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-group label {
    font-weight: 600;
    color: #2d3748;
    font-size: 0.95rem;
}

.required {
    color: #dc3545;
}

.form-input {
    padding: 0.75rem;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.95rem;
    transition: all 0.2s;
    font-family: 'Poppins', sans-serif;
}

.form-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

textarea.form-input {
    resize: vertical;
    min-height: 80px;
}

.form-hint {
    font-size: 0.85rem;
    color: #718096;
}

/* Info Box */
.info-box {
    background: #e6f3ff;
    border: 2px solid #0066cc;
    border-radius: 8px;
    padding: 1rem;
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}

.info-box svg {
    color: #0066cc;
    flex-shrink: 0;
    margin-top: 0.25rem;
}

.info-box strong {
    color: #003d7a;
    display: block;
    margin-bottom: 0.25rem;
}

.info-box p {
    color: #0066cc;
    font-size: 0.9rem;
    margin: 0;
}

/* Toggle Switch */
.toggle-container {
    background: #f7fafc;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    padding: 1.25rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.toggle-label {
    position: relative;
    display: inline-block;
    width: 56px;
    height: 32px;
    flex-shrink: 0;
}

.toggle-label input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-switch {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #cbd5e0;
    border-radius: 32px;
    transition: 0.3s;
}

.toggle-switch:before {
    position: absolute;
    content: "";
    height: 24px;
    width: 24px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    border-radius: 50%;
    transition: 0.3s;
}

.toggle-label input:checked + .toggle-switch {
    background: linear-gradient(135deg, #667eea, #764ba2);
}

.toggle-label input:checked + .toggle-switch:before {
    transform: translateX(24px);
}

.toggle-info strong {
    color: #2d3748;
    display: block;
    margin-bottom: 0.25rem;
    font-size: 1rem;
}

.toggle-info p {
    color: #718096;
    font-size: 0.9rem;
    margin: 0;
}

.form-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 2px solid #e2e8f0;
}

.btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    transition: all 0.2s;
    font-family: 'Poppins', sans-serif;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.btn-secondary {
    background: #e2e8f0;
    color: #4a5568;
}

.btn-secondary:hover {
    background: #cbd5e0;
}

@media (max-width: 768px) {
    .back-link {
        position: static;
        display: inline-flex;
        margin-bottom: 1rem;
    }

    .form-content {
        padding: 1.5rem;
    }

    .form-actions {
        flex-direction: column-reverse;
        gap: 0.75rem;
    }

    .btn {
        width: 100%;
        justify-content: center;
    }

    .toggle-container {
        flex-direction: column;
        align-items: flex-start;
    }
}
</style>

<script>
// Real-time validation for nombre
const nombreInput = document.getElementById('nombre');
const nombreHint = document.getElementById('nombreHint');

if (nombreInput) {
    nombreInput.addEventListener('input', function(e) {
        let value = e.target.value;
        
        // Only allow letters, numbers, spaces, hyphens, and periods
        value = value.replace(/[^A-Za-z0-9ÁÉÍÓÚáéíóúÑñ\s\-\.]/g, '');
        
        // Prevent more than 2 consecutive spaces
        value = value.replace(/\s{3,}/g, '  ');
        
        // Remove more than 2 consecutive same characters (except spaces)
        value = value.replace(/([^\s])\1{2,}/g, function(match) {
            return match.substring(0, 2);
        });
        
        e.target.value = value;
        
        // Update hint with character count
        const remaining = 30 - value.length;
        if (remaining < 10) {
            nombreHint.style.color = '#f59e0b';
            nombreHint.textContent = `${remaining} caracteres restantes`;
        } else {
            nombreHint.style.color = '#718096';
            nombreHint.textContent = '2-30 caracteres (letras, números, espacios, guiones y puntos)';
        }
    });
}

// Real-time validation for descripcion
const descripcionInput = document.getElementById('descripcion');
const descripcionHint = document.getElementById('descripcionHint');

if (descripcionInput) {
    descripcionInput.addEventListener('input', function(e) {
        let value = e.target.value;
        
        // Prevent more than 2 consecutive spaces
        value = value.replace(/\s{3,}/g, '  ');
        
        e.target.value = value;
        
        // Update hint with character count
        const length = value.trim().length;
        const remaining = 100 - value.length;
        
        if (length > 0 && length < 5) {
            descripcionHint.style.color = '#dc3545';
            descripcionHint.textContent = `Mínimo 5 caracteres (actual: ${length})`;
        } else if (remaining < 20) {
            descripcionHint.style.color = '#f59e0b';
            descripcionHint.textContent = `${remaining} caracteres restantes`;
        } else {
            descripcionHint.style.color = '#718096';
            descripcionHint.textContent = 'Máximo 100 caracteres (mínimo 5 si se completa)';
        }
    });
}

// Form validation before submit
document.getElementById('tipoForm').addEventListener('submit', function(e) {
    const nombre = nombreInput.value.trim();
    const descripcion = descripcionInput.value.trim();
    
    // Validate nombre length
    if (nombre.length < 2) {
        e.preventDefault();
        alert('El nombre debe tener al menos 2 caracteres');
        nombreInput.focus();
        return false;
    }
    
    if (nombre.length > 30) {
        e.preventDefault();
        alert('El nombre no puede exceder 30 caracteres');
        nombreInput.focus();
        return false;
    }
    
    // Validate descripcion if provided
    if (descripcion.length > 0 && descripcion.length < 5) {
        e.preventDefault();
        alert('La descripción debe tener al menos 5 caracteres si se completa');
        descripcionInput.focus();
        return false;
    }
    
    if (descripcion.length > 100) {
        e.preventDefault();
        alert('La descripción no puede exceder 100 caracteres');
        descripcionInput.focus();
        return false;
    }
    
    // Check for repeated characters in nombre
    const repeatedChars = /([^\s])\1{2,}/;
    if (repeatedChars.test(nombre)) {
        e.preventDefault();
        alert('El nombre no puede tener el mismo carácter repetido más de 2 veces seguidas');
        nombreInput.focus();
        return false;
    }
    
    // Check for more than 2 consecutive spaces
    if (/\s{3,}/.test(nombre) || /\s{3,}/.test(descripcion)) {
        e.preventDefault();
        alert('No se permiten más de 2 espacios consecutivos');
        return false;
    }
});

// ID validation for create form
const idInput = document.getElementById('id_tipo_documento');
if (idInput) {
    idInput.addEventListener('input', function(e) {
        // Remove any non-digit characters
        let value = e.target.value.replace(/\D/g, '');
        
        // Limit to 4 digits (max 9999)
        if (value.length > 4) {
            value = value.substring(0, 4);
        }
        
        e.target.value = value;
    });
}
</script>
{% endblock %}